<!doctype html>
<html lang="sv">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Labyrint Master: BRUTAL EDITION</title>
    <style>
        :root {
            --bg: #050608;
            --primary: #1d2bff;
            --brutal: #ff0044;
            --text: #cfd7ff;
            --panel: #12141d;
            --success: #00c853;
        }

        html, body {
            margin: 0;
            height: 100%;
            background: var(--bg);
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            background: #000;
        }

        .screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            color: var(--text);
            z-index: 10;
            padding: 20px;
            overflow-y: auto;
        }

        .hidden {
            display: none !important;
        }

        .hud {
            position: fixed;
            top: 25px;
            left: 25px;
            z-index: 5;
            display: flex;
            gap: 15px;
            pointer-events: none;
        }

        .pill {
            background: rgba(18, 20, 29, 0.95);
            color: #fff;
            padding: 12px 24px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 14px;
            font-weight: 700;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }

            .pill span {
                color: var(--primary);
                margin-right: 8px;
                font-size: 11px;
            }

        #progressBarContainer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.05);
            z-index: 5;
        }

        #progressBarFill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #00d2ff);
            transition: width 0.1s linear;
            box-shadow: 0 0 15px var(--primary);
        }

        .pause-trigger {
            position: fixed;
            top: 25px;
            right: 25px;
            z-index: 5;
            background: rgba(18, 20, 29, 0.95);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: 14px;
            cursor: pointer;
            font-weight: bold;
            pointer-events: auto;
        }

        h1 {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: #fff;
            text-shadow: 0 0 30px var(--primary);
            letter-spacing: 5px;
        }

        h2 {
            border-bottom: 2px solid var(--primary);
            width: 100%;
            max-width: 650px;
            padding-bottom: 5px;
            margin-top: 30px;
            font-size: 1.2rem;
            text-transform: uppercase;
        }

        .btn {
            cursor: pointer;
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: bold;
            margin: 8px;
            min-width: 240px;
            text-transform: uppercase;
            transition: 0.2s;
            box-shadow: 0 4px 0px #151eb3;
        }

            .btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 20px rgba(29, 43, 255, 0.3);
            }

        .btn-secondary {
            background: #222;
            box-shadow: 0 4px 0px #000;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 650px;
            margin: 15px 0 30px 0;
        }

        .level-card {
            background: var(--panel);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            border: 1px solid #222;
            transition: 0.2s;
        }

            .level-card:hover {
                border-color: var(--primary);
                background: #1a1e2b;
            }

        .cleared {
            border: 2px solid var(--success) !important;
        }

        .stats-list {
            width: 100%;
            max-width: 550px;
            background: var(--panel);
            border-radius: 20px;
            padding: 20px;
            max-height: 450px;
            overflow-y: auto;
            border: 1px solid #333;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            padding: 14px;
            border-bottom: 1px solid #222;
            font-size: 14px;
        }

        .tag {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
            margin-left: 10px;
            color: white;
        }

        .easy {
            background: #4caf50;
        }

        .medium {
            background: #ff9800;
        }

        .hard {
            background: #f44336;
        }

        .brutal {
            background: var(--brutal);
        }

        .overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.95);
            z-index: 100;
        }

        .popup {
            background: #fff;
            color: #000;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            min-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

            .popup h2 {
                border: none;
                font-size: 2.5rem;
                margin-bottom: 10px;
                color: #000;
            }

        #progressInfo {
            margin: 15px 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .pb-text {
            color: var(--success);
            font-size: 0.9rem;
            display: block;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div id="gameHud" class="hud hidden">
        <div class="pill"><span>BANA</span> <b id="hudTrack">001</b></div>
        <div class="pill"><span>FÖRSÖK</span> <b id="hudAttempts">1</b></div>
        <div class="pill"><span>KLART</span> <b id="hudProgress">0%</b></div>
    </div>

    <div id="progressBarContainer" class="hidden">
        <div id="progressBarFill"></div>
    </div>

    <button id="pauseBtn" class="pause-trigger hidden" onclick="togglePause()">PAUS</button>

    <div id="mainMenu" class="screen">
        <h1>LABYRINT</h1>
        <button class="btn" onclick="showScreen('levelSelect')">Starta Spelet</button>
        <button class="btn btn-secondary" onclick="showScreen('statsScreen')">Statistik</button>
        <button class="btn btn-secondary" onclick="showScreen('aboutScreen')">Om Spelet</button>
    </div>

    <div id="levelSelect" class="screen hidden">
        <button class="btn btn-secondary" style="align-self: flex-start; min-width: 120px;" onclick="showScreen('mainMenu')">← MENY</button>
        <h2>LÄTT</h2><div class="menu-grid" id="grid-easy"></div>
        <h2>MEDEL</h2><div class="menu-grid" id="grid-medium"></div>
        <h2>SVÅR</h2><div class="menu-grid" id="grid-hard"></div>
        <h2 style="color:var(--brutal); border-color:var(--brutal);">BRUTAL</h2><div class="menu-grid" id="grid-brutal"></div>
    </div>

    <div id="pauseScreen" class="screen hidden" style="background: rgba(5,6,8,0.85); backdrop-filter: blur(5px);">
        <h1>PAUSAD</h1>
        <button class="btn" onclick="togglePause()">Återuppta</button>
        <button class="btn btn-secondary" onclick="exitToMenu()">Avsluta till Meny</button>
    </div>

    <div id="statsScreen" class="screen hidden">
        <h1>STATISTIK</h1>
        <div id="statsSummary" style="margin-bottom: 20px; font-weight: bold; font-size: 1.4rem;"></div>
        <div class="stats-list" id="statsList"></div>
        <button class="btn btn-secondary" style="margin-top: 25px;" onclick="showScreen('mainMenu')">Tillbaka</button>
    </div>

    <div id="aboutScreen" class="screen hidden">
        <h1>OM SPELET</h1>
        <div style="max-width: 500px; text-align: center; background: var(--panel); padding: 40px; border-radius: 25px; border: 1px solid #333;">
            <p>Använd <b>Space</b> eller <b>Klicka</b> för att svänga vid cirklarna.</p>
            <p>På SVÅR och BRUTAL syns inga cirklar - lita på din tajming!</p>
            <p>Du behöver inte klicka vid sista punkten - kör bara i mål!</p>
            <p>Tryck på <b>P</b> för att pausa.</p>
        </div>
        <button class="btn btn-secondary" style="margin-top: 20px;" onclick="showScreen('mainMenu')">OK</button>
    </div>

    <div id="gameOverlay" class="overlay hidden">
        <div class="popup" id="popupBox">
            <h2 id="msgTitle">Resultat</h2>
            <div id="progressInfo"></div>
            <p id="msgBody"></p>
            <button id="overlayMainBtn" class="btn">NÄSTA</button>
            <button class="btn btn-secondary" onclick="exitToMenu()">MENY</button>
        </div>
    </div>

    <canvas id="c"></canvas>

    <script>
        // --- DATA ---
        const tracks = [];
        for (let i = 1; i <= 24; i++) {
            let diff = i <= 6 ? 'easy' : (i <= 12 ? 'medium' : (i <= 18 ? 'hard' : 'brutal'));
            let speed = 180 + (i * 20);
            let width = Math.max(5, 55 - (i * 2.5));
            let timing = 0.52 - (i * 0.015);
            if (diff === 'brutal') { speed = 600 + (i * 10); width = 5; timing = 0.15; }

            tracks.push({
                id: i.toString().padStart(3, '0'),
                num: i,
                difficulty: diff,
                speed: speed,
                width: width,
                timing: timing,
                pts: generateComplexPath(i, diff)
            });
        }

        function generateComplexPath(num, diff) {
            const pts = [{ x: 0, y: 0 }];
            let curX = 0, curY = 0;
            let segments = num <= 6 ? 12 : (num <= 18 ? 30 : 60);
            for (let j = 0; j < segments; j++) {
                const len = 350 + (Math.random() * 400);
                if (j % 2 === 0) curX += len;
                else curY += (len * (diff === 'brutal' ? 1.3 : 0.8)) * (Math.random() > 0.5 ? 1 : -1);
                pts.push({ x: Math.round(curX), y: Math.round(curY) });
            }
            return pts;
        }

        // --- ENGINE ---
        let currentTrack = null, pState = { x: 0, y: 0, prevX: 0, prevY: 0 }, player = { vx: 0, vy: 0, segIdx: 0 };
        let cam = { x: 0, y: 0, prevX: 0, prevY: 0 }, alive = false, started = false, paused = false, attempts = 1;
        let lastTime = 0, accumulator = 0, dt = 1 / 144, currentProg = 0;

        let zoom = 1, targetZoom = 1, prevZoom = 1;
        let isPreviewing = false, previewTargetIdx = 0;

        const canvas = document.getElementById("c"), ctx = canvas.getContext("2d");

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if (id === 'levelSelect') renderGrids();
            if (id === 'statsScreen') renderStats();
        }

        function renderGrids() {
            const history = JSON.parse(localStorage.getItem('maze_history_pro') || "{}");
            ['easy', 'medium', 'hard', 'brutal'].forEach(diff => {
                const grid = document.getElementById('grid-' + diff);
                grid.innerHTML = '';
                tracks.filter(t => t.difficulty === diff).forEach(t => {
                    const d = document.createElement('div');
                    d.className = `level-card ${history[t.id]?.cleared ? 'cleared' : ''}`;
                    d.innerHTML = `<strong>${t.id}</strong>`;
                    d.onclick = () => startTrack(t);
                    grid.appendChild(d);
                });
            });
        }

        function renderStats() {
            const history = JSON.parse(localStorage.getItem('maze_history_pro') || "{}");
            const list = document.getElementById('statsList');
            list.innerHTML = '';
            let clearedCount = Object.values(history).filter(h => h.cleared).length;
            document.getElementById('statsSummary').innerHTML = `KLARADE: ${clearedCount} / ${tracks.length}`;
            Object.keys(history).sort((a, b) => a - b).forEach(id => {
                const track = tracks.find(t => t.id === id);
                if (track) {
                    let pb = history[id].bestProg ? Math.round(history[id].bestProg) : 0;
                    let attemptsText = history[id].cleared ? `${history[id].bestAttempts} försök (PB)` : `${history[id].attempts} försök`;
                    list.innerHTML += `<div class="stats-item"><span>Bana ${id} <span class="tag ${track.difficulty}">${track.difficulty.toUpperCase()}</span></span> <span>PB: ${pb}% | ${attemptsText}</span></div>`;
                }
            });
        }

        function startTrack(t) {
            currentTrack = t; attempts = 1; paused = false; currentProg = 0;
            isPreviewing = true; previewTargetIdx = 0; targetZoom = 0.4;

            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('gameHud').classList.remove('hidden');
            document.getElementById('progressBarContainer').classList.remove('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            initGame();
        }

        function initGame() {
            alive = true; started = false; player.segIdx = 0; currentProg = 0;
            pState.x = pState.prevX = currentTrack.pts[0].x;
            pState.y = pState.prevY = currentTrack.pts[0].y;

            if (isPreviewing) {
                cam.x = cam.prevX = pState.x;
                cam.y = cam.prevY = pState.y;
            }

            updateVelocity();
            document.getElementById('hudTrack').textContent = currentTrack.id;
            document.getElementById('hudAttempts').textContent = attempts;
            document.getElementById('hudProgress').textContent = "0%";
            document.getElementById('progressBarFill').style.width = "0%";
            document.getElementById('gameOverlay').classList.add('hidden');
        }

        function updateVelocity() {
            const a = currentTrack.pts[player.segIdx], b = currentTrack.pts[player.segIdx + 1];
            const ang = Math.atan2(b.y - a.y, b.x - a.x);
            player.vx = Math.cos(ang); player.vy = Math.sin(ang);
        }

        function handleInput() {
            if (!alive || paused || isPreviewing) return;
            if (!started) { started = true; targetZoom = 1.0; return; }
            let next = currentTrack.pts[player.segIdx + 1];
            if (!next) return;
            let isFinalSegment = (player.segIdx + 1 >= currentTrack.pts.length - 1);
            let d = Math.hypot(next.x - pState.x, next.y - pState.y);
            if (!isFinalSegment && d < currentTrack.speed * currentTrack.timing) {
                player.segIdx++; pState.x = next.x; pState.y = next.y; updateVelocity();
            } else if (!isFinalSegment) fail();
        }

        function togglePause() {
            if (!alive) return;
            paused = !paused;
            document.getElementById('pauseScreen').classList.toggle('hidden', !paused);
        }

        function exitToMenu() {
            alive = false; started = false; paused = false; currentTrack = null;
            document.getElementById('gameHud').classList.add('hidden');
            document.getElementById('progressBarContainer').classList.add('hidden');
            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('gameOverlay').classList.add('hidden');
            document.getElementById('pauseScreen').classList.add('hidden');
            showScreen('mainMenu');
        }

        function fail() {
            alive = false;
            let history = JSON.parse(localStorage.getItem('maze_history_pro') || "{}");
            if (!history[currentTrack.id]) history[currentTrack.id] = { attempts: 0, bestProg: 0, cleared: false };
            if (!history[currentTrack.id].cleared) history[currentTrack.id].attempts = attempts;

            let isNewPB = currentProg > (history[currentTrack.id].bestProg || 0);
            let oldPB = history[currentTrack.id].bestProg || 0;
            if (isNewPB) history[currentTrack.id].bestProg = currentProg;
            localStorage.setItem('maze_history_pro', JSON.stringify(history));

            document.getElementById('msgTitle').textContent = "KRASCH!";
            document.getElementById('progressInfo').innerHTML = `Du klarade: ${Math.round(currentProg)}%` +
                (isNewPB ? `<span class="pb-text">NYTT PERSONBÄSTA! (Gammalt: ${Math.round(oldPB)}%)</span>` : `<span class="pb-text" style="color:#666">PB: ${Math.round(oldPB)}%</span>`);
            document.getElementById('msgBody').textContent = "Försök igen.";
            document.getElementById('overlayMainBtn').textContent = "FÖRSÖK IGEN";
            document.getElementById('overlayMainBtn').onclick = () => { attempts++; initGame(); };
            document.getElementById('gameOverlay').classList.remove('hidden');
        }

        function win() {
            alive = false;
            let history = JSON.parse(localStorage.getItem('maze_history_pro') || "{}");
            if (!history[currentTrack.id]) {
                history[currentTrack.id] = { attempts: attempts, bestAttempts: attempts, bestProg: 100, cleared: true };
            } else {
                if (!history[currentTrack.id].cleared || attempts < history[currentTrack.id].bestAttempts) history[currentTrack.id].bestAttempts = attempts;
                history[currentTrack.id].cleared = true;
                history[currentTrack.id].bestProg = 100;
            }
            localStorage.setItem('maze_history_pro', JSON.stringify(history));

            document.getElementById('msgTitle').textContent = "KLAR!";
            document.getElementById('progressInfo').innerHTML = `<span style="color:var(--success)">100% AVKLARAD!</span><br><small>Klarade på ${attempts} försök.</small>`;
            document.getElementById('msgBody').textContent = `Bana ${currentTrack.id} avklarad!`;
            const next = tracks.find(t => t.num === currentTrack.num + 1);
            document.getElementById('overlayMainBtn').textContent = next ? "NÄSTA BANA" : "MENY";
            document.getElementById('overlayMainBtn').onclick = next ? () => startTrack(next) : exitToMenu;
            document.getElementById('gameOverlay').classList.remove('hidden');
        }

        function updatePhysics() {
            if (!alive || paused) return;

            prevZoom = zoom;
            zoom += (targetZoom - zoom) * 0.05;

            if (isPreviewing) {
                let target = currentTrack.pts[previewTargetIdx];
                let dx = target.x - cam.x;
                let dy = target.y - cam.y;
                let dist = Math.hypot(dx, dy);

                cam.prevX = cam.x; cam.prevY = cam.y;
                cam.x += dx * 0.08;
                cam.y += dy * 0.08;

                if (dist < 50) {
                    previewTargetIdx++;
                    if (previewTargetIdx >= currentTrack.pts.length) {
                        isPreviewing = false;
                        targetZoom = 0.8;
                    }
                }
                return;
            }

            if (started) {
                pState.prevX = pState.x; pState.prevY = pState.y;
                cam.prevX = cam.x; cam.prevY = cam.y;
                pState.x += player.vx * currentTrack.speed * dt;
                pState.y += player.vy * currentTrack.speed * dt;
                cam.x += (pState.x - cam.x) * (dt * 12);
                cam.y += (pState.y - cam.y) * (dt * 12);

                let p1 = currentTrack.pts[player.segIdx], p2 = currentTrack.pts[player.segIdx + 1];
                let dx = p2.x - p1.x, dy = p2.y - p1.y;
                let segmentLenSq = dx * dx + dy * dy;
                let t = ((pState.x - p1.x) * dx + (pState.y - p1.y) * dy) / segmentLenSq;

                let totalSegments = currentTrack.pts.length - 1;
                let progress = ((player.segIdx + Math.max(0, Math.min(1, t))) / totalSegments) * 100;
                currentProg = Math.max(currentProg, progress);

                document.getElementById('hudProgress').textContent = Math.floor(currentProg) + "%";
                document.getElementById('progressBarFill').style.width = currentProg + "%";

                if (player.segIdx === currentTrack.pts.length - 2 && t >= 1) { win(); return; }

                let cx = p1.x + Math.max(0, Math.min(1, t)) * dx, cy = p1.y + Math.max(0, Math.min(1, t)) * dy;
                if (Math.hypot(pState.x - cx, pState.y - cy) > currentTrack.width) fail();
            } else {
                cam.prevX = cam.x; cam.prevY = cam.y;
                cam.x += (pState.x - cam.x) * 0.1;
                cam.y += (pState.y - cam.y) * 0.1;
            }
        }

        function loop(timestamp) {
            let frameTime = (timestamp - lastTime) / 1000;
            if (frameTime > 0.1) frameTime = 0.1;
            lastTime = timestamp;
            if (!paused) accumulator += frameTime;
            while (accumulator >= dt) { updatePhysics(); accumulator -= dt; }
            draw(accumulator / dt);
            requestAnimationFrame(loop);
        }

        function draw(alpha) {
            ctx.fillStyle = "#050608"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (currentTrack) {
                const lerpX = pState.prevX + (pState.x - pState.prevX) * alpha;
                const lerpY = pState.prevY + (pState.y - pState.prevY) * alpha;
                const lerpCamX = cam.prevX + (cam.x - cam.prevX) * alpha;
                const lerpCamY = cam.prevY + (cam.y - cam.prevY) * alpha;
                const lerpZoom = prevZoom + (zoom - prevZoom) * alpha;

                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.scale(lerpZoom, lerpZoom);
                ctx.translate(-lerpCamX, -lerpCamY);

                // Rita bana
                ctx.strokeStyle = currentTrack.difficulty === 'brutal' ? "#ff0044" : "#fff";
                ctx.lineWidth = currentTrack.width * 2; ctx.lineCap = "round"; ctx.lineJoin = "round";
                ctx.beginPath(); ctx.moveTo(currentTrack.pts[0].x, currentTrack.pts[0].y);
                currentTrack.pts.forEach(p => ctx.lineTo(p.x, p.y)); ctx.stroke();

                // SVÄNG-CIRKLAR: Visas endast på 'easy' och 'medium'
                if (currentTrack.difficulty === 'easy' || currentTrack.difficulty === 'medium') {
                    ctx.fillStyle = "rgba(29, 43, 255, 0.25)";
                    currentTrack.pts.forEach((p, idx) => {
                        if (idx > 0 && idx < currentTrack.pts.length - 1) {
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, currentTrack.speed * currentTrack.timing, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    });
                }

                // Spelare
                ctx.shadowBlur = 15; ctx.shadowColor = currentTrack.difficulty === 'brutal' ? "#ff0044" : "#1d2bff";
                ctx.fillStyle = ctx.shadowColor; ctx.beginPath(); ctx.arc(lerpX, lerpY, 8.5, 0, Math.PI * 2); ctx.fill();

                // Text overlays
                if (!started && !isPreviewing && alive) {
                    ctx.fillStyle = "white";
                    ctx.font = "bold 40px 'Segoe UI'";
                    ctx.textAlign = "center";
                    ctx.fillText("KLICKA FÖR ATT STARTA", lerpX, lerpY - 60);
                }
                if (isPreviewing) {
                    ctx.fillStyle = currentTrack.difficulty === 'brutal' ? "#ff0044" : "#1d2bff";
                    ctx.font = "bold 50px 'Segoe UI'";
                    ctx.textAlign = "center";
                    ctx.fillText("REKOGNOSCERAR BANA...", cam.x, cam.y - 120);
                }

                ctx.restore();
            }
        }

        window.addEventListener("keydown", e => {
            if (e.code === "Space") { e.preventDefault(); handleInput(); }
            if (e.code === "KeyP") togglePause();
        });
        canvas.addEventListener("pointerdown", e => { e.preventDefault(); handleInput(); });
        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        window.onresize(); requestAnimationFrame(loop);
    </script>
</body>
</html>